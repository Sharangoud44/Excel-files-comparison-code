<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Excel Comparison Tool ‚Äî Prefer First Row Header</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Calibri, Arial, sans-serif; background: #f5f7fb; padding: 24px; }
        h2 { margin-bottom: 12px; color: #0b3d91; }
        input[type="file"] { margin-right: 8px; }
        button { padding: 8px 14px; background: #0b63ff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background:#054ec4; }

        .excel-box { background: #fff; border: 1px solid #d6dde8; border-radius: 6px; margin-top: 18px; overflow: hidden; }
        .excel-header { background: linear-gradient(#dbe9ff, #cfe2ff); padding: 10px 14px; border-bottom: 1px solid #b9d0ff; font-weight: 700; color:#08306b; }
        .excel-row { padding: 10px 14px; border-bottom: 1px solid #f0f4f9; color:#111; }
        .excel-row.small { padding: 6px 14px; color:#333; font-size: 14px; }
        .icon { margin-right: 8px; }
        .ok { color: #0a8a00; font-weight: 600; }
        .fail { color: #c92b2b; font-weight: 600; }
        .muted { color: #666; }
        .code { font-family: Consolas, monospace; background:#f7f9fc; padding:6px 8px; border-radius:4px; display:inline-block; }
        .cols { margin-top:8px; font-size: 14px; }
    </style>
</head>
<body>
    <h2>Excel Comparison Tool ‚Äî Prefer First Row Header</h2>

    <input type="file" id="file1" accept=".xlsx,.xls,.csv">
    <label class="muted">Excel 1</label>
    <br><br>
    <input type="file" id="file2" accept=".xlsx,.xls,.csv">
    <label class="muted">Excel 2</label>
    <br><br>
    <button onclick="compareExcel()">Compare</button>

    <div id="result"></div>

<script>
/* ---------- Helpers ---------- */
function readExcelPromise(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: "array" });
                const sheet = wb.Sheets[wb.SheetNames[0]]; // FIRST SHEET ONLY
                const arr = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
                resolve(arr);
            } catch (err) {
                reject(err);
            }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

function looksNumeric(s) {
    if (s === null || s === undefined) return false;
    s = String(s).trim();
    if (s === "") return false;
    return /^[-+]?[$‚Çπ‚Ç¨¬£]?\d{1,3}(?:[\d,]*\d)?(?:\.\d+)?%?$/.test(s) || /^[-+]?[$‚Çπ‚Ç¨¬£]?\d+(?:\.\d+)?%?$/.test(s);
}

function containsLetters(s) {
    if (s === null || s === undefined) return false;
    return /[A-Za-z]/.test(String(s));
}

/* NEW: Prefer first row if it looks like header (>=2 textual cells) */
function detectHeaderRowPreferFirst(sheetArr) {
    // NEW SIMPLE HEADER DETECTION:
    // Pick the first row that has ANY alphabetic character (A-Z)
    for (let i = 0; i < sheetArr.length; i++) {
        const row = sheetArr[i] || [];
        for (let c = 0; c < row.length; c++) {
            const cell = row[c];
            if (cell && /[A-Za-z]/.test(String(cell))) {
                return {
                    header: row.map(x => x === undefined ? "" : String(x).trim()),
                    headerIndex: i
                };
            }
        }
    }

    // fallback: treat row 0 as header
    const fallback = (sheetArr[0] || []).map(x => x === undefined ? "" : String(x).trim());
    return { header: fallback, headerIndex: 0 };
}


function isNumberLike(val) {
    if (val === null || val === undefined) return false;
    if (typeof val === "number") return true;
    const s = String(val).trim();
    if (s === "") return false;
    return looksNumeric(s);
}

function extractNumFormat(val) {
    const s = String(val || "").trim();
    return {
        hasComma: s.indexOf(",") !== -1,
        currency: (s.match(/[$‚Çπ‚Ç¨¬£]/) || [null])[0],
        decimals: s.includes(".") ? s.split(".")[1].replace(/[^0-9]/g,"").length : 0,
        isPercent: s.endsWith("%")
    };
}

function sampleColumnValue(sheetArr, headerIndex, colIndex) {
    for (let r = headerIndex + 1; r < sheetArr.length; r++) {
        const row = sheetArr[r] || [];
        const cell = row[colIndex];
        if (cell !== undefined && cell !== null && String(cell).trim() !== "") return String(cell).trim();
    }
    return null;
}

/* ---------- Main compare function ---------- */
async function compareExcel() {
    const file1 = document.getElementById("file1").files[0];
    const file2 = document.getElementById("file2").files[0];
    const resultDiv = document.getElementById("result");
    resultDiv.innerHTML = "";

    if (!file1 || !file2) {
        alert("Please upload both Excel files.");
        return;
    }

    try {
        const [arr1, arr2] = await Promise.all([readExcelPromise(file1), readExcelPromise(file2)]);

        // use the new prefer-first-row detection
        const h1 = detectHeaderRowPreferFirst(arr1);
        const h2 = detectHeaderRowPreferFirst(arr2);

        const header1 = h1.header; const headerIdx1 = h1.headerIndex;
        const header2 = h2.header; const headerIdx2 = h2.headerIndex;

        const rowCount1 = Math.max(0, arr1.length - (headerIdx1 + 1));
        const rowCount2 = Math.max(0, arr2.length - (headerIdx2 + 1));

        let html = "";

        // 1) Column Count
        html += `<div class="excel-box">
                    <div class="excel-header">1) Column Count</div>
                    <div class="excel-row small"><span class="icon">üìå</span>Excel 1 Column Count: <span class="code">${header1.length}</span></div>
                    <div class="excel-row small"><span class="icon">üìå</span>Excel 2 Column Count: <span class="code">${header2.length}</span></div>
                    <div class="excel-row small muted">Detected header row: Excel1 ‚Üí ${headerIdx1+1}, Excel2 ‚Üí ${headerIdx2+1}</div>
                 </div>`;

        // 2) Column Order check (position wise)
        const maxCols = Math.max(header1.length, header2.length);
        let mismatchPos = [];
        for (let c = 0; c < maxCols; c++) {
            const a = header1[c] === undefined ? "" : header1[c];
            const b = header2[c] === undefined ? "" : header2[c];
            if (a !== b) mismatchPos.push({ pos: c+1, a, b });
        }

        html += `<div class="excel-box"><div class="excel-header">2) Column Order</div>`;
        if (mismatchPos.length === 0) {
            html += `<div class="excel-row ok"><span class="icon">‚úîÔ∏è</span>Column Order: MATCHING</div>`;
        } else {
            html += `<div class="excel-row fail"><span class="icon">‚ùå</span>Column Order MISMATCHED</div>`;
            html += `<div class="excel-row small"><b>Differences (position-wise):</b></div>`;
            mismatchPos.forEach(m => {
                html += `<div class="excel-row small"><b>[Col-${m.pos}]</b> Excel1 ‚Üí <span class="code">${m.a || "(blank)"}</span>  |  Excel2 ‚Üí <span class="code">${m.b || "(blank)"}</span></div>`;
            });

            // Show mapping where header names from Excel1 exist in Excel2
            const map2 = {};
            header2.forEach((nm, idx) => { if (nm) map2[nm] = (map2[nm] || []).concat(idx+1); });
            html += `<div class="excel-row small muted">Note: For Excel1 headers that differ by position, below shows where that header name appears (if anywhere) in Excel2.</div>`;
            mismatchPos.forEach(m => {
                const hname = m.a || "";
                const found = (map2[hname] || []).length ? map2[hname].join(", ") : "(not present)";
                html += `<div class="excel-row small">Excel1 [Col-${m.pos}] <span class="code">${hname}</span> ‚Üí Excel2 positions: ${found}</div>`;
            });
        }
        html += `</div>`;

        // 3) Row Count
        html += `<div class="excel-box"><div class="excel-header">3) Row Count</div>`;
        html += `<div class="excel-row small">Excel 1 Row Count: <span class="code">${rowCount1}</span></div>`;
        html += `<div class="excel-row small">Excel 2 Row Count: <span class="code">${rowCount2}</span></div>`;
        if (rowCount1 === rowCount2) {
            html += `<div class="excel-row ok"><span class="icon">‚úîÔ∏è</span>Row Count: MATCHING</div>`;
        } else {
            html += `<div class="excel-row fail"><span class="icon">‚ùå</span>Row Count: NOT MATCHING</div>`;
        }
        html += `</div>`;

        // 4) Number Format Check
        html += `<div class="excel-box"><div class="excel-header">4) Number Format Check</div>`;

        let formatProblems = [];
        for (let c = 0; c < maxCols; c++) {
            const sample1 = sampleColumnValue(arr1, headerIdx1, c);
            const sample2 = sampleColumnValue(arr2, headerIdx2, c);

            if (sample1 !== null && sample2 !== null && isNumberLike(sample1) && isNumberLike(sample2)) {
                const fmt1 = extractNumFormat(sample1);
                const fmt2 = extractNumFormat(sample2);

                if (fmt1.hasComma !== fmt2.hasComma ||
                    fmt1.decimals !== fmt2.decimals ||
                    String(fmt1.currency || "") !== String(fmt2.currency || "") ||
                    fmt1.isPercent !== fmt2.isPercent) {

                    const name1 = header1[c] || `(Col-${c+1})`;
                    const name2 = header2[c] || `(Col-${c+1})`;

                    formatProblems.push({
                        pos: c+1,
                        header1: name1,
                        header2: name2,
                        sample1, sample2,
                        fmt1, fmt2
                    });
                }
            }
        }

        if (formatProblems.length === 0) {
            html += `<div class="excel-row ok small"><span class="icon">‚úîÔ∏è</span>Number Formats: MATCHING (checked first available data samples)</div>`;
        } else {
            html += `<div class="excel-row fail small"><span class="icon">‚ùå</span>Number Format differences found (${formatProblems.length})</div>`;
            formatProblems.forEach(p => {
                html += `<div class="excel-row small"><b>[Col-${p.pos}]</b> Excel1: <span class="code">${p.header1}</span> ‚Üí <span class="code">${p.sample1}</span> | Excel2: <span class="code">${p.header2}</span> ‚Üí <span class="code">${p.sample2}</span></div>`;
                html += `<div class="excel-row small muted">Formats ‚Üí Excel1: ${JSON.stringify(p.fmt1)} | Excel2: ${JSON.stringify(p.fmt2)}</div>`;
            });
        }

        html += `</div>`;

        // Headers preview
        html += `<div class="excel-box"><div class="excel-header">Headers Preview (detected)</div>`;
        html += `<div class="excel-row small"><b>Excel1 (row ${headerIdx1+1}):</b> <span class="cols">${header1.map((h,i)=>`[${i+1}] ${h||"(blank)"}`).join(" | ")}</span></div>`;
        html += `<div class="excel-row small"><b>Excel2 (row ${headerIdx2+1}):</b> <span class="cols">${header2.map((h,i)=>`[${i+1}] ${h||"(blank)"}`).join(" | ")}</span></div>`;
        html += `</div>`;

        resultDiv.innerHTML = html;

    } catch (err) {
        document.getElementById("result").innerHTML = `<div class="excel-box"><div class="excel-header">Error</div><div class="excel-row small fail">${String(err)}</div></div>`;
        console.error(err);
    }
}
</script>
</body>
</html>
